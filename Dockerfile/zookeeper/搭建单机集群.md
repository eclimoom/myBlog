# 参考

- [http://zookeeper.apache.org/releases.html](http://zookeeper.apache.org/releases.html)

## 安装zookeeper

### 下载zookeeper

从国内镜像站点下载会快点

```bash
wget http://mirrors.hust.edu.cn/apache/zookeeper/zookeeper-3.5.5/apache-zookeeper-3.5.5-bin.tar.gz
```

### 解压

执行以下指令解压后，移动到刚才创建的工作目录。

```bash
tar -zxvf apache-zookeeper-3.5.5-bin.tar.gz
mv apache-zookeeper-3.5.5-bin zookeeper01
```

### 修改环境变量

```bash
vi /etc/profile

export PATH=/root/zookeeper/zookeeper01/bin:$PATH

source /etc/profile
```

## 修改配置文件

```bash
cp conf/zoo_sample.cfg conf/zoo.cfg
vi zoo.cfg
```

### zookeeper01配置

```conf
# The number of milliseconds of each tick
tickTime=2000
# The number of ticks that the initial
# synchronization phase can take
initLimit=10
# The number of ticks that can pass between
# sending a request and getting an acknowledgement
syncLimit=5
# the directory where the snapshot is stored.
# do not use /tmp for storage, /tmp here is just
# example sakes.
dataDir=/root/zookeeper/data01
dataLogDir=/root/zookeeper/data01/logs
# the port at which the clients will connect
clientPort=2181
# the maximum number of client connections.
# increase this if you need to handle more clients
#maxClientCnxns=60
#
# Be sure to read the maintenance section of the
# administrator guide before turning on autopurge.
#
# http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance
#
# The number of snapshots to retain in dataDir
#autopurge.snapRetainCount=3
# Purge task interval in hours
# Set to "0" to disable auto purge feature
#autopurge.purgeInterval=1
# server.服务编号=服务地址、LF通信端口、选举端口
server.1=192.168.137.128:2888:3888
server.2=192.168.137.128:22888:23888
server.3=192.168.137.128:32888:33888
```

### zookeeper02配置

```conf
# The number of milliseconds of each tick
tickTime=2000
# The number of ticks that the initial
# synchronization phase can take
initLimit=10
# The number of ticks that can pass between
# sending a request and getting an acknowledgement
syncLimit=5
# the directory where the snapshot is stored.
# do not use /tmp for storage, /tmp here is just
# example sakes.
dataDir=/root/zookeeper/data02
dataLogDir=/root/zookeeper/data02/logs
# the port at which the clients will connect
clientPort=22181
# the maximum number of client connections.
# increase this if you need to handle more clients
#maxClientCnxns=60
#
# Be sure to read the maintenance section of the
# administrator guide before turning on autopurge.
#
# http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance
#
# The number of snapshots to retain in dataDir
#autopurge.snapRetainCount=3
# Purge task interval in hours
# Set to "0" to disable auto purge feature
#autopurge.purgeInterval=1
# server.服务编号=服务地址、LF通信端口、选举端口
server.1=192.168.137.128:2888:3888
server.2=192.168.137.128:22888:23888
server.3=192.168.137.128:32888:33888
```

### zookeeper03配置

```conf
# The number of milliseconds of each tick
tickTime=2000
# The number of ticks that the initial
# synchronization phase can take
initLimit=10
# The number of ticks that can pass between
# sending a request and getting an acknowledgement
syncLimit=5
# the directory where the snapshot is stored.
# do not use /tmp for storage, /tmp here is just
# example sakes.
dataDir=/root/zookeeper/data03
dataLogDir=/root/zookeeper/data03/logs
# the port at which the clients will connect
clientPort=32181
# the maximum number of client connections.
# increase this if you need to handle more clients
#maxClientCnxns=60
#
# Be sure to read the maintenance section of the
# administrator guide before turning on autopurge.
#
# http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance
#
# The number of snapshots to retain in dataDir
#autopurge.snapRetainCount=3
# Purge task interval in hours
# Set to "0" to disable auto purge feature
#autopurge.purgeInterval=1
# server.服务编号=服务地址、LF通信端口、选举端口
server.1=192.168.137.128:2888:3888
server.2=192.168.137.128:22888:23888
server.3=192.168.137.128:32888:33888
```

### 创建data目录和logs目录

```bash
mkdir /root/zookeeper/data01
mkdir /root/zookeeper/data01/logs
```

### 创建`myid`文件

`data01/myid`中的内容对应配置文件中的`server.1`为1

```bash
echo "1" > data01/myid
echo "2" > data02/myid
echo "3" > data03/myid
```

## 启动服务

```bash
#启动服务 - start
zkServer.sh start ~/zookeeper/zoo01.cfg
zkServer.sh start ~/zookeeper/zoo02.cfg
zkServer.sh start ~/zookeeper/zoo03.cfg
# 停止服务 - stop
# 重启服务 - restart
# 查看服务状态 - status
➜  ~ zkServer.sh status ~/zookeeper/zoo01.cfg
/usr/bin/java
ZooKeeper JMX enabled by default
Using config: /root/zookeeper/zoo01.cfg
Client port found: 2181. Client address: localhost.
Mode: follower
➜  ~ zkServer.sh status ~/zookeeper/zoo02.cfg
/usr/bin/java
ZooKeeper JMX enabled by default
Using config: /root/zookeeper/zoo02.cfg
Client port found: 22181. Client address: localhost.
Mode: leader
➜  ~ zkServer.sh status ~/zookeeper/zoo03.cfg
/usr/bin/java
ZooKeeper JMX enabled by default
Using config: /root/zookeeper/zoo03.cfg
Client port found: 32181. Client address: localhost.
Mode: follower
```

### ZooKeeper命令行

```bash
# 连接服务器 zkCli -server IP:PORT
zkCli.sh -server 192.168.137.128:2181

# 帮助命令
[zk: 192.168.137.128:2181(CONNECTED) 1] help
ZooKeeper -server host:port cmd args
        addauth scheme auth
        close
        config [-c] [-w] [-s]
        connect host:port
        create [-s] [-e] [-c] [-t ttl] path [data] [acl]
        delete [-v version] path
        deleteall path
        delquota [-n|-b] path
        get [-s] [-w] path
        getAcl [-s] path
        history
        listquota path
        ls [-s] [-w] [-R] path
        ls2 path [watch]
        printwatches on|off
        quit
        reconfig [-s] [-v version] [[-file path] | [-members serverID=host:port1:port2;port3[,...]*]] | [-add serverId=host:port1:port2;port3[,...]]* [-remove serverId[,...]*]
        redo cmdno
        removewatches path [-c|-d|-a] [-l]
        rmr path
        set [-s] [-v version] path data
        setAcl [-s] [-v version] [-R] path acl
        setquota -n|-b val path
        stat [-w] path
        sync path


# 获取根节点列表，默认会有一个zookeeper节点，节点列表就像linux目录一样，根节点为/
ls /

# 创建节点(create 命令)
[zk: 192.168.137.128:2181(CONNECTED) 3] create /node1 "node1"
Created /node1

# 获取节点的数据(get 命令)
[zk: 192.168.137.128:2181(CONNECTED) 4] get /node1
node1

# 更新节点数据内容(set 命令)
[zk: 192.168.137.128:2181(CONNECTED) 5] set /node1 "fangfang"

# 查看节点状态(stat 命令)
[zk: 192.168.137.128:2181(CONNECTED) 6] stat /node1
cZxid = 0x100000007
ctime = Wed Jul 17 01:23:43 CST 2019
mZxid = 0x100000008
mtime = Wed Jul 17 01:24:37 CST 2019
pZxid = 0x100000007
cversion = 0
dataVersion = 1
aclVersion = 0
ephemeralOwner = 0x0
dataLength = 8
numChildren = 0

# 删除节点(delete 命令)
delete /node1
```
